name: Sugarmaker CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ======================
          # LINUX
          # ======================
          - name: linux-x64
            os: ubuntu-22.04
            script: build-linux64.sh

          - name: linux-x86
            os: ubuntu-22.04
            script: build-linux32.sh

          - name: linux-armv7l
            os: ubuntu-22.04
            script: build-armv7l.sh

          - name: linux-aarch64
            os: ubuntu-22.04
            script: build-aarch64.sh

          # ======================
          # MACOS
          # ======================
          - name: macos-x64
            os: macos-latest
            script: build-osx.sh

          # ======================
          # WINDOWS
          # ======================
          - name: windows-x64
            os: windows-latest
            script: build-w64.sh

          - name: windows-x86
            os: windows-latest
            script: build-w32.sh

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # ======================
      # LINUX SETUP
      # ======================
      - name: üêß Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            libcurl4-openssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            git

      # ======================
      # MACOS SETUP
      # ======================
      - name: üçé Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install \
            autoconf \
            automake \
            libtool \
            pkg-config \
            curl \
            openssl@3

      # ======================
      # WINDOWS SETUP (FIXED)
      # ======================
      - name: ü™ü Setup MSYS2
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-curl
            autoconf
            automake
            libtool

      # ======================
      # AUTOGEN
      # ======================
      - name: ‚öôÔ∏è Run autogen.sh
        shell: bash
        run: |
          chmod +x autogen.sh
          ./autogen.sh

      # ======================
      # BUILD (UNIX)
      # ======================
      - name: üî® Build Sugarmaker (${{ matrix.name }})
        if: runner.os != 'Windows'
        shell: bash
        run: |
          chmod +x ${{ matrix.script }}
          ./${{ matrix.script }}

      # ======================
      # BUILD (WINDOWS / MSYS2)
      # ======================
      - name: üî® Build Sugarmaker (${{ matrix.name }})
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          chmod +x ${{ matrix.script }}
          ./${{ matrix.script }}

      # ======================
      # VERIFY STATIC (FAIL IF NOT)
      # ======================
      - name: üîç Verify static binary
        if: runner.os != 'macOS'
        shell: bash
        run: |
          file sugarmaker | grep -E "static|statically linked"

      # ======================
      # ARTIFACTS
      # ======================
      - name: üì¶ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sugarmaker-${{ matrix.name }}
          path: |
            sugarmaker*
            **/*.exe
