name: Sugarmaker CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ======================
          # LINUX
          # ======================
          - name: linux-x64
            os: ubuntu-22.04
            script: build-linux64.sh

          - name: linux-x86
            os: ubuntu-22.04
            script: build-linux32.sh

          - name: linux-armv7l
            os: ubuntu-22.04
            script: build-armv7l.sh

          - name: linux-aarch64
            os: ubuntu-22.04
            script: build-aarch64.sh

          # ======================
          # MACOS
          # ======================
          - name: macos-x64
            os: macos-latest
            script: build-osx.sh

          # ======================
          # WINDOWS
          # ======================
          - name: windows-x64
            os: windows-latest
            script: build-w64.sh

          - name: windows-x86
            os: windows-latest
            script: build-w32.sh

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # ======================
      # LINUX SETUP
      # ======================
      - name: üêß Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            automake \
            autoconf \
            libtool \
            pkg-config \
            cmake \
            curl \
            git

      # ======================
      # MACOS SETUP
      # ======================
      - name: üçé Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install automake autoconf libtool cmake pkg-config

      # ======================
      # WINDOWS SETUP
      # ======================
      - name: ü™ü Setup MSYS2
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-cmake
            autoconf
            automake
            libtool

      # ======================
      # AUTOGEN
      # ======================
      - name: ‚öôÔ∏è Run autogen.sh
        shell: bash
        run: |
          chmod +x autogen.sh
          ./autogen.sh

      # ======================
      # BUILD
      # ======================
      - name: üî® Build Sugarmaker (${{ matrix.name }})
        shell: bash
        run: |
          chmod +x ${{ matrix.script }}
          ./${{ matrix.script }}

      # ======================
      # ARTIFACTS
      # ======================
      - name: üì¶ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sugarmaker-${{ matrix.name }}
          path: |
            **/build/**
            **/bin/**
            sugarmaker*
